#!/usr/bin/env ruby
#
# convert the old data model for the gaptool server
# to the new struct

libpath = File.expand_path(File.join(File.dirname(__FILE__), "..", "lib"))
$:.unshift(libpath)
require "#{libpath}/helpers/redis"
require "#{libpath}/helpers/data"
include DataHelper

# First, remove cruft. Like all servers created but never registered, etc
['instance:*', '_*', 'apikey:*', 'service:*', 'running', 'ec2*',
 'failover', 'capacity', 'sg:*'].each do |pattern|
  $redis.keys(pattern).each do |key|
    $redis.del key
  end
end

# get info for all applications and convert to new struct
$redis.keys('app:*').each do |key|
  appname = key.sub('app:', '')
  $redis.sadd('apps', appname)
  role = $redis.hget(key, "role")
  unless role.nil?
    $redis.sadd("role:#{role}:apps", appname)
  end
  $redis.del(key)
end

# convert hosts
$redis.keys('host:*').each do |key|
  pfx, role, env, iid = key.split(':')
  data = $redis.hgetall(key)
  data['role'] = role
  $redis.sadd('roles', role)
  data['environment'] = env
  addserver(iid, data, nil)
  $redis.del(key)
  # remove stale keys from hsh
  $redis.hdel "instance:#{iid}", ["capacity", "mirror", "secret", 'instance']
end

$redis.smembers('instances').each do |inst|
  $redis.hdel "instance:#{inst}", ["capacity", "mirror", "secret", "instance"]
  if $redis.hget("instance:#{inst}", 'chef_runlist') == "recipe[init]"
    $redis.hdel "instance:#{inst}", "chef_runlist"
  end
end

$redis.save
