apt-get update
apt-get install -ymq zsh git libssl-dev ruby1.9.1-full build-essential
curl -LO https://www.getchef.com/chef/install.sh
bash install.sh

cat << 'EOFKEY' > /root/.ssh/id_rsa
<%= @initkey %>
EOFKEY
chmod 600 /root/.ssh/id_rsa
echo 'StrictHostKeyChecking no' > /root/.ssh/config
git clone -b <%= @chef_branch %> <%= @chef_repo %> /root/ops
echo '<%= @json %>' > /root/init.json
chef-solo -c /root/ops/cookbooks/init.rb -j /root/init.json -E <%= @chef_environment %> && \
    (rm /root/.ssh/id_rsa; rm /root/install.sh; userdel -r ubuntu; rm -rf /root/.ssh; rm -rf /root/ops)
